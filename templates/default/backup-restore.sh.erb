#!/bin/bash

help() {
	echo ""
	echo "Usage: $0 backup_id"
	echo ""
	echo "Restores a backup of the cluster with id=backup_id. Should be run at all data nodes."
	echo ""
	exit 1
}

if [ $# -ne 1 ] ; then
    help()
fi    

BACKUP_DIR="<%= node.ndb.base_dir %>/backup/"
BACKUP_ID=$1
case $1 in
    "-h"|"--help"|"-help")
	help();;
    *)
        ;;
esac 

# space-separated values
datanodes=( <%= @datanodes %> )
node_ids=( <%= @node_ids %> )

# ndb_restore [-c connectstring] -n node_id [-m] -b backup_id -r --backup_path=/path/to/backup/files

# Read this documentation first:
# https://dev.mysql.com/doc/refman/5.7/en/mysql-cluster-programs-ndb-restore.html
# Need '--rebuild-indexes' as we have unique indexes in hopsworks/hops
# 'datanodes' should start at nodeid=1 and progress up to nodeid=N
j=1
for i in "${datanodes[@]}" 
do	 
  echo "Restoring backup at: $i"
  ssh $i "<%= node.mysql.base_dir %>/bin/ndb_restore -c <%= node.ndb.connectstring %> -n $j -b $1 --backup_path=$BACKUP_DIR --rebuild-indexes"
  j+=1
done
	 
exit $?

